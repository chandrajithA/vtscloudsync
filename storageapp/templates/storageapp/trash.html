{% extends base_template %}
{% load static %}

{% block title %}Trash - Cloudsync{% endblock %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/trash.css' %}">
{% endblock %}

{% block content %}

<div class="trash-alert">
    <span>âš  Items in trash will be permanently deleted after 30 days</span>
</div>



<div id="pageLoader" class="page-loader" style="display:none;">
    <div class="spinner"></div>
    <p>Processing...</p>
</div>

<div class="trash-stats">
    <div class="stat-box">
        <p>Items in Trash</p>
        <h3 id="trashCount">{{ total_files }}</h3>
    </div>
    <div class="stat-box">
        <p>Total Size</p>
        <h3 id="trashSize">{{ total_size|filesizeformat }}</h3>
    </div>
    <div class="stat-box danger">
        <p>Expiring soon</p>
        <h3 id="trashExpiring">{{ expiring_soon }}</h3>
    </div>
</div>

<div id="toastContainer"></div>

<div class="trash-actions">
    <button class="btn-primary" onclick="restoreAll()">Restore All</button>
    <button class="btn-danger" onclick="emptyTrash()">Empty Trash</button>
</div>

<div class="trash-list">
{% for file in files %}
<div class="trash-item" id="file-{{ file.id }}">

    <div class="trash-left">
        <img src="{% static 'images/file.png' %}">
        <div>
            <strong>{{ file.file_name }}</strong>
            <p>{{ file.file_type|capfirst }} â€¢ {{ file.file_size|filesizeformat }}</p>
        </div>
    </div>

    <div class="trash-meta">
        <span>Deleted {{ file.deleted_at|timesince }} ago</span>
        <span class="expire">Expires in {{ file.days_left }} days</span>
    </div>

    <div class="trash-buttons">
        <button class="restore" onclick="restoreFile({{ file.id }})">Restore</button>
        <button class="delete" onclick="deleteFile({{ file.id }})">Delete</button>
    </div>

</div>
{% endfor %}

{% if not files %}
<p id="emptyResults" class="empty">
    No files found
</p>
{% endif %}

<p id="noTrashResults" class="empty" style="display:none;">
    No files found
</p>

</div>



{% endblock %}

{% block script %}
<script>

document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("globalSearchInput");
    const trashItems = document.querySelectorAll(".trash-item");
    const noResults = document.getElementById("noTrashResults");

    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase().trim();
        let visibleCount = 0;

        trashItems.forEach(item => {
            const name = item
                .querySelector(".trash-left strong")
                .innerText
                .toLowerCase();

            if (!query || name.includes(query)) {
                item.style.display = "flex";
                visibleCount++;
            } else {
                item.style.display = "none";
            }
        });

        // âœ… Show empty text ONLY when searching and nothing matches
        if (query && visibleCount === 0) {
            noResults.style.display = "block";
            if(document.getElementById("emptyResults")){
                document.getElementById("emptyResults").style.display="none";
            }
        } else {
            noResults.style.display = "none";
            if(document.getElementById("emptyResults")){
                document.getElementById("emptyResults").style.display="block";
            }
        }
    });
});


function restoreFile(id) {
    const row = document.getElementById(`file-${id}`);
    if (!row) return;

    // ðŸ”„ Show loading state
    row.classList.add("loading");

    fetch(`/user/trash/restore/${id}/`)
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                row.remove();
                showMessage("File restored successfully", "success");
                updateStats(data.stats);
            }
        })
        .catch(err => {
            showMessage(err.error || "Restore failed", "error");
            row.classList.remove("loading"); // âŒ do NOT remove row
        });
}

function deleteFile(id) {
    if (!confirm("Delete permanently?")) return;
    fetch(`/user/trash/delete/${id}/`)
    .then(r => r.json())
    .then(() => document.getElementById(`file-${id}`).remove());
}

function restoreAll() {
    showLoader(true);

    fetch(`/user/trash/restore-all/`)
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
            }
            return res.json();
        })
        .then(data => {
            showMessage(data.message, "success");

            // ðŸ”„ Delay reload so message is visible
            setTimeout(() => {
                location.reload();
            }, 1200);
        })
        .catch(err => {
            showLoader(false);
            showMessage(err.error || "Restore failed", "error");
        });
}

function emptyTrash() {
    if (!confirm("Empty trash permanently?")) return;

    showLoader(true);

    fetch(`/user/trash/empty/`)
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
            }
            return res.json();
        })
        .then(data => {
            showMessage(data.message, "success");

            // â³ let user see message
            setTimeout(() => {
                location.reload();
            }, 1200);
        })
        .catch(err => {
            showLoader(false);
            showMessage(err.error || "Failed to empty trash", "error");
        });
}

function updateStats(stats) {
    document.getElementById("trashCount").innerText = stats.count;
    document.getElementById("trashSize").innerText = formatBytes(stats.size);
    document.getElementById("trashExpiring").innerText = stats.expiring;
}

function formatBytes(bytes) {
    if (bytes === 0) return "0 KB";
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + " " + sizes[i];
}

function showMessage(text, type="success") {
    const container = document.getElementById("toastContainer");
    const div = document.createElement("div");
    div.className = `toast ${type}`;
    div.innerText = text;

    container.appendChild(div);

    setTimeout(() => div.remove(), 3500);
}

function showLoader(show) {
    document.getElementById("pageLoader").style.display = show ? "flex" : "none";
}

</script>
{% endblock %}
