{% extends base_template %}
{% load static %}
{% load humanize %}
{% load tz %}

{% block title %}Shared - Cloudsync{% endblock %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/shared.css' %}">
{% endblock %}

{% block content %}

{% if messages %}
<div class="toast-container">
    {% for message in messages %}
    <div class="toast {{ message.tags }}">
        <span>{{ message }}</span>
        <button onclick="closeToast(this)">×</button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="shared-wrapper">

    <div class="shared-header">
        <h2>Shared Files</h2>
        <p>Files shared with you and by you</p>
    </div>

    <!-- Stats -->
    <div class="shared-stats">

        <div class="stat-card" data-filter="all">
            <div class="stat-icon green">
                <img src="{% static 'images/file.png' %}">
            </div>
            <div class="stat-info">
                <h4>Total Shared</h4>
                <strong>{{ total_shared }} Files</strong>
            </div>
        </div>

        <div class="stat-card" data-filter="by-me">
            <div class="stat-icon blue">
                <img src="{% static 'images/share.png' %}">
            </div>
            <div class="stat-info">
                <h4>Shared by you</h4>
                <strong>{{ shared_by_me|length }} Files</strong>
            </div>
        </div>

        <div class="stat-card" data-filter="with-me">
            <div class="stat-icon purple">
                <img src="{% static 'images/shareicon.png' %}">
            </div>
            <div class="stat-info">
                <h4>Shared with you</h4>
                <strong>{{ shared_with_me|length }} Files</strong>
            </div>
        </div>
 
    </div>

    <!-- Table -->
    <div class="shared-table">

        <div class="shared-head">
            <span>Name</span>
            <span>Owner</span>
            <span>Receiver</span>
            <span>Date</span>
            <span></span>
        </div>

        {% for s in shared_with_me %}
        <div class="shared-row" data-type="with-me">
            <div class="shared-file">
                {% if s.file.file_type == "image" %}
                    <img src="{% static 'images/image.png' %}">
                {% elif s.file.file_type == "video" %}
                    <img src="{% static 'images/video.png' %}">
                {% elif s.file.file_type == "document" %}
                    <img src="{% static 'images/adobe.png' %}">
                {% else %}
                    <img src="{% static 'images/file.png' %}">
                {% endif %}
                <div>
                    <div class="shared-file-name">{{ s.file.file_name }}</div>
                    <div class="shared-file-meta">
                        {{ s.file.file_size|filesizeformat }}
                    </div>
                </div>
            </div>

            <span>{{ s.owner.username }}</span>
            <span>Me</span>
            <span>{{ s.shared_at|date:"M d" }}</span>

            
            <div class="recent-actions">
                {% comment %} {% if s.file.file_type == "other" %}
                <a href="{{ s.file.file_url }}" target="_blank" title="View" class="icon-btn">
                    <img src="{% static 'images/hidepassword_icon.png' %}">
                </a>
                {% endif %}    


                <a href="{% url 'storageapp:download_file' s.file.id %}" class="icon-btn">
                    <img src="{% static 'images/download.png' %}">
                </a> {% endcomment %}

                {% if s.file.file_type|lower != "other" %}
                <a href="{% url 'storageapp:view_file' s.file.id %}" target="_blank" class="icon-btn">
                    <img src="{% static 'images/hidepassword_icon.png' %}" alt="">
                </a>
                {% endif %}

                <a href="{% url 'storageapp:download_file' s.file.id %}"
                class="icon-btn download"
                target="_blank"
                title="Download">
                    <img src="{% static 'images/download.png' %}" alt="">
                </a>


                <a href="javascript:void(0)"
                    title="Share"
                    class="icon-btn"
                    onclick="openShareModal('{{ s.file.file_url }}')">
                        <img src="{% static 'images/shareicon.png' %}" alt="Share">
                </a>


                <!-- DELETE -->
                <button onclick="removeShared('{{ s.id }}')" title="Remove" class="icon-btn">
                    <img src="{% static 'images/trash.png' %}">
                </button>


            </div>
        </div>
        {% endfor %}

        {% for s in shared_by_me %}
        <div class="shared-row" data-type="by-me">
            <div class="shared-file">
                {% if s.file.file_type == "image" %}
                    <img src="{% static 'images/image.png' %}">
                {% elif s.file.file_type == "video" %}
                    <img src="{% static 'images/video.png' %}">
                {% elif s.file.file_type == "document" %}
                    <img src="{% static 'images/adobe.png' %}">
                {% else %}
                    <img src="{% static 'images/file.png' %}">
                {% endif %}
                <div>
                    <div class="shared-file-name">{{ s.file.file_name }}</div>
                    <div class="shared-file-meta">
                        {{ s.file.file_size|filesizeformat }}
                    </div>
                </div>
            </div>

            <span>Me</span>
            <span>{{ s.shared_with.username }}</span>
            <span>{{ s.shared_at|localtime|date:"d M y, h:i A" }}</span>
            

            <div class="recent-actions">
                {% comment %} {% if s.file.file_type == "other" %}
                <a href="{{ s.file.file_url }}" target="_blank" title="View" class="icon-btn">
                    <img src="{% static 'images/hidepassword_icon.png' %}">
                </a>
                {% endif %}

                <a href="{% url 'storageapp:download_file' s.file.id %}" class="icon-btn">
                    <img src="{% static 'images/download.png' %}">
                </a> {% endcomment %}


                {% if s.file.file_type|lower != "other" %}
                <a href="{% url 'storageapp:view_file' s.file.id %}" target="_blank" class="icon-btn">
                    <img src="{% static 'images/hidepassword_icon.png' %}" alt="">
                </a>
                {% endif %}

                <a href="{% url 'storageapp:download_file' s.file.id %}"
                class="icon-btn download"
                target="_blank"
                title="Download">
                    <img src="{% static 'images/download.png' %}" alt="">
                </a>

                <a href="javascript:void(0)"
                    title="Share"
                    class="icon-btn"
                    onclick="openShareModal('{{ s.file.file_url }}')">
                        <img src="{% static 'images/shareicon.png' %}" alt="Share">
                </a>
                


                <!-- DELETE -->
                <button onclick="removeSharedOwn('{{ s.id }}')" title="Remove" class="icon-btn">
                    <img src="{% static 'images/trash.png' %}">
                </button>


            </div>
        </div>
        {% endfor %}

        {% if not shared_with_me and not shared_by_me %}
        <p id="emptyResults" class="empty">
            No files found
        </p>
        {% endif %}


        <p id="noSharedResults" class="empty" style="display:none;">
            No files found
        </p>

    </div>
</div>

<div id="shareModal" class="share-modal">
    <div class="share-box">
        <div class="share-header">
            <h3>Share file</h3>
            <button class="close-btn" onclick="closeShareModal()">✕</button>
        </div>

        <p class="share-subtitle">
            Anyone with this link can view the file
        </p>

        <div class="share-icons">
            <a id="share-whatsapp" target="_blank" class="share-item whatsapp">
                <img src="{% static 'images/whatsapp.png' %}">
                <span>WhatsApp</span>
            </a>

            <a id="share-facebook" target="_blank" class="share-item facebook">
                <img src="{% static 'images/facebook.png' %}">
                <span>Facebook</span>
            </a>

            <a id="share-twitter" target="_blank" class="share-item twitter">
                <img src="{% static 'images/twitter.png' %}">
                <span>Twitter</span>
            </a>

            <a id="share-telegram" target="_blank" class="share-item telegram">
                <img src="{% static 'images/telegram.png' %}">
                <span>Telegram</span>
            </a>

            <button onclick="copyLink()" class="share-item copy">
                <img src="{% static 'images/link.png' %}">
                <span>Copy link</span>
            </button>
        </div>
    </div>
</div>


{% endblock %}

{% block script %}
<script>
function removeShared(sharedId) {
    if (!confirm("Remove this shared file?")) return;

    fetch(`/user/shared/${sharedId}/remove/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || "Failed");
        }
    })
    .catch(() => alert("Error occurred"));
}


function removeSharedOwn(sharedId) {
    if (!confirm("Remove this shared file?")) return;

    fetch(`/user/shared/${sharedId}/remove_own/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || "Failed");
        }
    })
    .catch(() => alert("Error occurred"));
}


let currentShareUrl = "";

function openShareModal(url) {
    currentShareUrl = url;

    document.getElementById("share-whatsapp").href =
        `https://wa.me/?text=${encodeURIComponent(url)}`;

    document.getElementById("share-facebook").href =
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;

    document.getElementById("share-twitter").href =
        `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}`;

    document.getElementById("share-telegram").href =
        `https://t.me/share/url?url=${encodeURIComponent(url)}`;

    document.getElementById("shareModal").style.display = "flex";
}

function closeShareModal() {
    document.getElementById("shareModal").style.display = "none";
}

function copyLink() {
    navigator.clipboard.writeText(currentShareUrl);
    alert("Link copied to clipboard");
    closeShareModal();
}


document.addEventListener("DOMContentLoaded", () => {
    const cards = document.querySelectorAll(".stat-card");
    const rows = document.querySelectorAll(".shared-row");
    const noResults = document.getElementById("noSharedResults");

    function filterRows(type) {
        let visible = 0;

        rows.forEach(row => {
            if (type === "all" || row.dataset.type === type) {
                row.style.display = "grid";
                visible++;
            } else {
                row.style.display = "none";
            }
        });

    }

    cards.forEach(card => {
        card.addEventListener("click", () => {

            // ✅ Clear global search input if exists
            const searchInput = document.getElementById("globalSearchInput");
            if (searchInput) {
                searchInput.value = "";
            }

            // ✅ Reset active state
            cards.forEach(c => c.classList.remove("active"));
            card.classList.add("active");

            // ✅ Apply filter
            filterRows(card.dataset.filter);
        });
    });

    // ✅ Default: show ALL files on load
    filterRows("all");
});


document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("globalSearchInput");
    if (!searchInput) return;

    const sharedRows = document.querySelectorAll(".shared-row");
    const noResults = document.getElementById("noSharedResults");

    searchInput.addEventListener("input", function () {
        const query = this.value.toLowerCase().trim();
        let visibleCount = 0;

        sharedRows.forEach(row => {
            const fileName = row
                .querySelector(".shared-file-name")
                .innerText
                .toLowerCase();

            const owner = row
                .querySelector("span")
                .innerText
                .toLowerCase();

            if (fileName.includes(query) || owner.includes(query)) {
                row.style.display = "grid";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });

        // ✅ Show / hide "No files found"
        if (query && visibleCount === 0) {
            noResults.style.display = "block";
            if(document.getElementById("emptyResults")){
                document.getElementById("emptyResults").style.display="none";
            }
        } else {
            noResults.style.display = "none";
            if(document.getElementById("emptyResults")){
                document.getElementById("emptyResults").style.display="block";
            }
        }
    });
});

function closeToast(btn) {
    const toast = btn.parentElement;
    toast.style.opacity = "0";
    toast.style.transform = "translateX(60px)";
    setTimeout(() => toast.remove(), 300);
}

document.addEventListener("DOMContentLoaded", () => {
    const toasts = document.querySelectorAll(".toast");

    toasts.forEach((toast, index) => {
        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateX(60px)";
            setTimeout(() => toast.remove(), 300);
        }, 5000 + index * 300);
    });
});


(function() {
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;

    fetch("{% url 'storageapp:set_timezone' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "timezone=" + encodeURIComponent(tz)
    });
})();

</script>
{% endblock %}