{% extends base_template %}
{% load static %}

{% block title %}Upload - Cloudsync{% endblock %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/upload.css' %}">
{% endblock %}

{% block content %}

{% if messages %}
<div class="toast-container">
    {% for message in messages %}
    <div class="toast {{ message.tags }}">
        <span>{{ message }}</span>
        <button onclick="closeToast(this)">√ó</button>
    </div>
    {% endfor %}
</div>
{% endif %}

<h2 class="page-title">Upload Files</h2>
<p class="page-subtitle">Drag and drop your files or browse to upload</p>

<div class="upload-box" id="dropZone">
    <div class="upload-icon">‚òÅÔ∏è</div>
    <h3>Drag and drop files here</h3>
    {% if not storage_near_limit %}
    <p>Or click the button below to browse the files</p>
    {% endif %}

    {% if storage_near_limit %}
    <p style="color:#ef4444; margin-top:20px;">
        üö´ Storage limit reached. Upgrade your plan to upload more files.
    </p>
    {% endif %}

    {% if storage_near_limit %}
    <button class="browse-btn disabled" disabled>
        Storage Full
    </button>
    {% else %}
    <button class="browse-btn" onclick="document.getElementById('fileInput').click()">
        Browse Files
    </button>
    {% endif %}

    <p id="uploadStatus"
        style="margin-top:10px; font-weight:500; display:none;">
    </p>

    <input type="file" id="fileInput" name="file" multiple hidden {% if storage_near_limit %}disabled{% endif %}>

</div>
   
    <div class="upload-list" id="uploadList">
    {% for file in recent_uploads %}
    {% if file.status == "success" %}
    <div class="upload-row">

        <!-- LEFT -->
        <div class="upload-left">
            <div class="file-icon">
                
                <img class="file-icon-img" src="{% static 'images/checkmark.png' %}" alt="image">
                
            </div>

            <div>
                <div class="file-name">{{ file.file_name }}</div>
                <div class="file-size">{{ file.file_size|filesizeformat }}</div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="upload-right">
            <span class="status-text completed">Completed</span>
            <span class="check">‚úî</span>
        </div>

        <!-- PROGRESS BAR -->
        <div class="bar completed">
            <div class="bar-fill" style="width:100%;"></div>
        </div>

    </div>
    {% else %}
    <div class="upload-row">

        <!-- LEFT -->
        <div class="upload-left">
            <div class="file-icon">
                
                <img class="file-icon-img" src="{% static 'images/close.png' %}" alt="image">
                
            </div>

            <div>
                <div class="file-name error">{{ file.file_name }}</div>
                <div class="file-size">{{ file.file_size|filesizeformat }}</div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="upload-right">
            <span class="status-text completed">{{file.failure_message}}</span>
        </div>

        <!-- PROGRESS BAR -->
        <div class="bar error">
            <div class="bar-fill" style="width:100%;"></div>
        </div>

    </div>
    {% endif %}
{% empty %}
    <p style="color:#6b7280;" id="no-upload-text">No recent uploads</p>
{% endfor %}
</div>
    <form id="uploadForm" method="POST" enctype="multipart/form-data">

        {% csrf_token %}
        
    </form>

    {% if error %}
        <p style="color:red;">{{ error }}</p>
    {% endif %}




{% endblock %}



{% block script %}

<script>
const input = document.getElementById("fileInput");
const uploadList = document.getElementById("uploadList");
const noUploadText = document.getElementById("no-upload-text");
const browseBtn = document.querySelector(".browse-btn");
const uploadStatus = document.getElementById("uploadStatus");
const csrfToken = "{{ csrf_token }}";

input.addEventListener("change", () => {
    const files = [...input.files];
    uploadFilesSequentially(files);
});

async function uploadFilesSequentially(files) {
    const total = files.length;
    let completed = 0;

    // üîí Hide browse button
    input.disabled = true;
    if (browseBtn) browseBtn.style.display = "none";

    // üìä Show status
    uploadStatus.style.display = "block";
    uploadStatus.textContent = `Uploading 0 of ${total} files`;

    for (const file of files) {
        await uploadSingleFile(file);
        completed++;

        // üîÑ Live update
        uploadStatus.textContent =
            completed < total
                ? `Uploading ${completed} of ${total} files`
                : `Finished - (${total} files)`;
    }

    // ‚úÖ Show browse button again
    input.disabled = false;
    input.value = "";  
    if (browseBtn) browseBtn.style.display = "inline-block";
    
}

function uploadSingleFile(file) {
    return new Promise((resolve) => {
        const row = document.createElement("div");
        row.className = "upload-row uploading";

        let iconUrl = "{% static 'images/server.png' %}";

        row.innerHTML = `
            <div class="upload-left">
                <div class="file-icon">
                    
                        <img class="file-icon-img" class="file-icon" src="${iconUrl}" alt="file">
                </div>
                
                <div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                </div>
            </div>

            <div class="upload-right">
                <span class="status-text">Uploading‚Ä¶</span>
                <span class="check hidden">‚úî</span>
                <img src="{% static 'images/close.png' %}" class="cancel-btn">
            </div>

            <div class="bar">
                <div class="bar-fill"></div>
            </div>
        `;

        uploadList.prepend(row);

            if (noUploadText){
                noUploadText.style.display = "none";
            }
        
        const bar = row.querySelector(".bar-fill");
        const status = row.querySelector(".status-text");
        const cancelBtn = row.querySelector(".cancel-btn");

        const formData = new FormData();
        formData.append("file", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "{% url 'storageapp:upload_page' %}");
        xhr.setRequestHeader("X-CSRFToken", csrfToken);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percent = (e.loaded / e.total) * 100;
                bar.style.width = percent + "%";
                if(percent === 100){
                    cancelBtn.style.display = "none";
                }
            }
        };

        xhr.onload = () => {
            let res = {};
            try {
                res = JSON.parse(xhr.responseText || "{}");
            } catch (e) {}

            // ‚úÖ SUCCESS (200)
            if (xhr.status === 200 && res.success) {

                const rejected = res.rejected_files?.[0];

                if (rejected) {
                    row.classList.add("error");
                    status.innerHTML = `
                        <span class="error-text">
                            ${rejected.reason}
                        </span>
                    `;
                    bar.style.background = "#ef4444";
                    cancelBtn.style.display = "none";
                    row.querySelector(".file-icon-img").src = "{% static 'images/close.png' %}";
                }
                else{
                    row.classList.remove("uploading");
                    row.classList.add("completed");

                    bar.style.width = "100%";
                    status.innerHTML = "Completed";

                    cancelBtn.style.display = "none";
                    // show check mark
                    const check = row.querySelector(".check");
                    check.classList.remove("hidden");

                    // change left icon to tick
                    row.querySelector(".file-icon-img").src = "{% static 'images/checkmark.png' %}";
                }        
                
            } 
            
            resolve();
        };

        xhr.onerror = () => {
            status.innerHTML = "Network error";
            row.classList.add("error");
            bar.style.background = "#ef4444";
            cancelBtn.style.display = "none";
            row.querySelector(".file-icon-img").src = "{% static 'images/close.png' %}";
            resolve();
        };

        cancelBtn.addEventListener("click", () => {
            xhr.abort();  // ‚ùå stops upload immediately
            row.classList.add("cancelled");
            status.innerText = "Cancelled";
            bar.style.background = "#ef4444";
            row.querySelector(".file-icon-img").src = "{% static 'images/close.png' %}";
            
            // üî• Notify backend
            const cancelData = new FormData();
            cancelData.append("file_name", file.name);
            cancelData.append("file_size", file.size);

            fetch("{% url 'storageapp:upload_cancelled' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken
                },
                body: cancelData
            });
            resolve();
        });

        xhr.send(formData);
    });
    
}


function closeToast(btn) {
    const toast = btn.parentElement;
    toast.style.opacity = "0";
    toast.style.transform = "translateX(60px)";
    setTimeout(() => toast.remove(), 300);
}

document.addEventListener("DOMContentLoaded", () => {
    const toasts = document.querySelectorAll(".toast");

    toasts.forEach((toast, index) => {
        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateX(60px)";
            setTimeout(() => toast.remove(), 300);
        }, 5000 + index * 300);
    });
});

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return "0 Bytes";

    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));

    const value = bytes / Math.pow(k, i);
    return value.toFixed(value < 10 && i > 0 ? 2 : 1) + " " + sizes[i];
}
</script>



{% endblock %}